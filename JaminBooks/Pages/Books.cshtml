@page
@model BooksModel
@{
    ViewData["Title"] = "Books";
    ViewData["IsLoggedIn"] = Model.CurrentUser != null;
    ViewData["Name"] = Model.CurrentUser == null ? "" : Model.CurrentUser.FirstName + " " + Model.CurrentUser.LastName;
}

<script>$("a.books").addClass("active")</script>

<style>
    .book-overlay {
        background-color: rgba(0, 0, 0, .5);
        text-align: center;
    }
    #Books {
        min-height: 30vh;
        padding: 20px;
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        flex-wrap: wrap;
    }
    .book {
        margin: 25px;
    }
    #BookView {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1050;
        overflow-x: hidden;
        overflow-y: auto;
        background-color: rgba(0, 0, 0, .8);
        transition: background-color .4s;
    }

        #BookView.hovered {
            background-color: rgba(0, 0, 0, .4);
        }

        #BookViewBody {
            width: 75%;
            margin: auto;
            background-color: white;
            margin-top: 180px;
            position: relative;
        }

    #BookImage {
        height: 350px;
        position: absolute;
        top: -50px;
        left: -50px;
    }

    .star-overlay {
        position: absolute;
        width: 20px;
        height: 21px;
    }

    .icon-div {
        width: 100px;
        height: 100px;
        overflow: hidden;
        border-radius: 100px;
    }
</style>

<div id="SearchBar" class="row">
    <div class="col-6 offset-4">
        <div class="form-group">
            <div class="input-group mt-3">
                <input type="text" id="Search" class="form-control" placeholder="Search...">
                <div class="input-group-append">
                    <select id="SearchType" class="form-control">
                        <option value="1">General</option>
                        <option value="2">Title</option>
                        <option value="3">Author</option>
                        <option value="4">Publisher</option>
                        <option value="5">ISBN</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div id="Sidebar" class="col-2">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h3>Category</h3>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-12">
                                <select id="BookCat" class="form-control">
                                    <option value="-1">Category...</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div id="SearchCats" class="col-12"></div>
                        </div>
                    </div>
                </div>
            </div>
            @*<div class="row">
                <div class="col-12">
                    <h3>Price</h3>
                    <div class="form-group">
                        <div class="row">
                            <label for="last_name" class="col-sm-3 col-form-label">Min: </label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <label for="last_name" class="col-sm-3 col-form-label">Max: </label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>*@
            <div class="row">
                <div class="col-12">
                    <h4>Sort By</h4>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-12">
                                <select id="SortType" class="form-control">
                                    <option value="1">Relavence</option>
                                    <option value="2">Price: Low to High</option>
                                    <option value="3">Price: High to Low</option>
                                    <option value="4">New to Old</option>
                                    <option value="5">Old to New</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-10">
        <div class="row">
            <div id="Books" class="col-12">

            </div>
            <div class="col-12">
                <div id="LoadIcon" class="row text-center mt-5 mb-5">
                    <div class="col-12">
                        <i class="fas fa-circle-notch fa-spin fa-4x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="BookView" style="display:none">
    <div id="BookViewBody" class="pb-5">
        <img id="BookImage" src="/images/love elliot.png"/>
        <div class="container" style="overflow:auto;">
            <div class="row mt-3">
                <div class="col-3">
                    <div style="margin-top: 320px">
                        <button class="btn btn-primary btn-lg ml-4">Add to Cart</button>
                    </div>
                </div>
                <div class="col-8">
                    <span id="BookID" class="d-none">-1</span>
                    <h2 id="BookTitle">Title</h2>
                    <h4 id="BookAuthor">Author</h4>
                    <h3>$<span id="BookPrice">0.00</span></h3>
                    <div id="Rating">
                        <span>
                            <i class="far fa-star"></i>
                            <i class="far fa-star"></i>
                            <i class="far fa-star"></i>
                            <i class="far fa-star"></i>
                            <i class="far fa-star"></i>
                        </span>
                    </div>
                    <div id="Description" class="mt-3"></div>
                    <hr />
                    <div id="Details" class="mt-3">
                        <div class="row">
                            <div class="col-lg-6 col-md-12">
                                <div class="form-group row">
                                    <label class="col-4 col-form-label font-weight-bold">ISBN 10:</label>
                                    <div class="col-8">
                                        <input id="ISBN10" type="text" readonly class="form-control-plaintext" value="Unknown">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-4 col-form-label font-weight-bold">ISBN 13:</label>
                                    <div class="col-8">
                                        <input id="ISBN13" type="text" readonly class="form-control-plaintext" value="Unknown">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-4 col-form-label font-weight-bold">Copyright:</label>
                                    <div class="col-8">
                                        <input id="CopyrightDate" type="text" readonly class="form-control-plaintext" value="Unknown">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12">
                                <div class="form-group row">
                                    <label class="col-4 col-form-label font-weight-bold">Publication Date:</label>
                                    <div class="col-8">
                                        <input id="PublicationDate" type="text" readonly class="form-control-plaintext" value="Unknown">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-4 col-form-label font-weight-bold">Publisher:</label>
                                    <div class="col-8">
                                        <input id="Publisher" type="text" readonly class="form-control-plaintext" value="Unknown">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div id="Ratings" class="mt-3">
                        <h3>Leave a review</h3>
                        <div class="col-12">
                            <span id="RatingStars">
                                <span class="star-overlay"></span>
                                <i class="fas fa-star"></i>
                                <span class="star-overlay"></span>
                                <i class="far fa-star"></i>
                                <span class="star-overlay"></span>
                                <i class="far fa-star"></i>
                                <span class="star-overlay"></span>
                                <i class="far fa-star"></i>
                                <span class="star-overlay"></span>
                                <i class="far fa-star"></i>
                            </span>
                            <textarea class="w-100 mt-3" placeholder="What did you think?..."></textarea>
                        </div>
                        <div id="RatingMessages"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var index = 0;
    var loading = false;
    var loaded = false;
    $(document).ready(function () {
        $.ajax({
            type: "POST",
            url: "Model/GetBookCategories",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },
            success: function (response) {
                response = JSON.parse(response);
                $.each(response, function (key, value) {
                    $("#BookCat").append("<option value=" + key + ">" + value + "</option>")
                });
            }
        });

        $("#BookView").click(function (e) {
            if (e.target === this) {
                $("#BookView").fadeOut(function () { 
                    $("body").removeAttr("style");
                    $("nav").removeAttr("style");
                });
                $("#BookView").unbind("hover");
                $("#BookViewBody").unbind("hover");
                $("#BookView").removeClass("hovered");
            }
        });

        $("#RatingStars .star-overlay").click(function () {
            var star = $(this).next("svg");

            if (star.attr("data-prefix") == "far") {
                star.attr("data-prefix", "fas");
                star.prevAll("svg").attr("data-prefix", "fas");
            } else {
                $(this).next().nextAll("svg").attr("data-prefix", "far");
            }
        });

        $("#BookCat").change(function () {
            var id = $("#BookCat").val();
            var name = $("#BookCat option:selected").text();

            if (id == -1) return;
            $("#SearchCats").append('<span class="badge badge-primary m-1" data-id='
                + id + '><i class="fas fa-times mr-1" onclick="removeCat(this)"></i>' + name + '</span>');

            $("#BookCat option:selected").hide();
            $("#BookCat").val(-1);
        });

        $("#BookCat, #SearchType, #SortType").change(function () {
            loadBooks(true);
        });

        $("#Search").on('input', function () {
            loadBooks(true);
        });

        $(window).scroll(function () {
            if ($("#Books .book").last().isInViewport()) {
                loadBooks(false);
            }
        });

        loadBooks();
    });

    function removeCat(button) {
        var cat = $(button).parent();
        cat.remove();
        $("#BookCat option[value='" + cat.data("id") + "']").show();
        loadBooks(true);
    }

    function loadBooks(reset) {

        if (reset) {
            index = 0;
            loaded = false;
        }

        if (loading || loaded) return;
        loading = true;
        if(!reset) $("#LoadIcon").show();
        var count = 10;

        var cats = [];
        $("#SearchCats .badge").each(function () { cats.push($(this).data("id")) });

        var data = {
            Index: index,
            Count: count,
            Search: $("#Search").val(),
            SearchType: $("#SearchType").val(),
            Cats: cats,
            SortType: $("#SortType").val()
        }

        $.ajax({
            type: "POST",
            url: "Model/LoadBooks",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                response = JSON.parse(response);

                if (reset) $("#Books").empty();

                response[1].forEach(function (book) {

                    var bookcard = "";

                    var bookrating = "</span>";
                    var count = 5;
                    for (var i = 0; i < book.Rating; i++, count--)
                        bookrating += '<i class="fas fa-star"></i>'
                    for (var i = count; i > 0; i--)
                        bookrating += '<i class="far fa-star"></i>'

                    bookcard += '<div class="card text-white book" onclick="showBookView(this)" style="width: 200px" '
                    bookcard += 'data-id="' + book.BookID + '"'
                    bookcard += 'data-title="' + book.Title + '"'
                    bookcard += 'data-price="' + book.Price + '"'
                    bookcard += 'data-description="' + book.Description + '"'
                    bookcard += 'data-authors=\'' + JSON.stringify(book.Authors) + '\''
                    bookcard += 'data-categories=\'' + JSON.stringify(book.Categories) + '\''
                    bookcard += 'data-rating="' + book.Rating + '"'
                    bookcard += 'data-isbn10="' + book.ISBN10 + '"'
                    bookcard += 'data-isbn13="' + book.ISBN13 + '"'
                    bookcard += 'data-copyright="' + book.CopyrightDate + '"'
                    bookcard += 'data-publication="' + book.PublicationDate + '"'
                    bookcard += 'data-publisher="' + book.Publisher.PublisherName + '"'
                    bookcard += '> '
                    bookcard += '<img class="card-img" src="/images/love elliot.png">'
                    bookcard += '<div class="card-img-overlay book-overlay" style="display:none">'
                    bookcard += '<h5 class="card-title">' + book.Title + '</h5>'
                    bookcard += '<h5 class="card-text mt-4">$' + book.Price + '</h5>'
                    bookcard += '<h5 class="card-text mt-4">' + bookrating + '</h5>'
                    bookcard += '</div>'
                    bookcard += '</div>'

                    $("#Books").append(bookcard);
                });

                $(".book").hover(function () {
                    $(this).find(".book-overlay").fadeIn();
                },
                function () {
                    $(this).find(".book-overlay").fadeOut();
                })

                if (response[0] < count)
                    loaded = true;
                index += response[0];
                loading = false;
                $("#LoadIcon").hide();
            },
            failure: function (response) {
                alert(response);
            }
        });
    }

    function showBookView(book) {
        book = $(book);
        $("#BookTitle").text(book.data("title"));
        $("#BookPrice").text(book.data("price"));
        $("#Description").text(book.data("description"));

        $("#ISBN10").val(book.data("isbn10"));
        $("#ISBN13").val(book.data("isbn13"));
        $("#CopyrightDate").val(book.data("copyright"));
        $("#PublicationDate").val(book.data("publication"));
        $("#Publisher").val(book.data("publisher"));
        $("#RatingMessages").empty();

        var authors = book.data("authors");
        var authorstring = "";
        authors.forEach(function (author) { authorstring += author.FirstName + " " + author.LastName + ", " })
        $("#BookAuthor").text(authorstring.slice(0, -2));

        var rating = book.data("rating");
        $("#Rating svg").each(function (i) { 
            if (i < rating) $(this).attr("data-prefix", "fas");
            else $(this).attr("data-prefix", "far");
        })

        $("body").css("overflow", "hidden");
        $("body").css("margin-right", getScrollBarWidth());
        $("nav").css("margin-right", getScrollBarWidth());

        $("#BookView").fadeIn(function () { 
            $("#BookViewBody").hover(function (event) {
                $("#BookView").removeClass("hovered");
            }, function () {
                $("#BookView").addClass("hovered");
            });

            $("#BookView").hover(function (event) {
                $("#BookView").addClass("hovered");
            }, function () {
                $("#BookView").removeClass("hovered");
            });
            $("#BookView").removeClass("hovered");
        });

        $.ajax({
            type: "POST",
            url: "Model/GetRatings",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },
            data: JSON.stringify({ BookID: book.data("id") }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                response = JSON.parse(response);

                response.forEach(function (rating) {

                    var ratingmessage = "";
                    var ratingstars = "</span>";
                    var count = 5;
                    for (var i = 0; i < rating.RatingValue; i++ , count--)
                        ratingstars += '<i class="fas fa-star"></i>'
                    for (var i = count; i > 0; i--)
                        ratingstars += '<i class="far fa-star"></i>'

                    ratingmessage += '<div class="rating"'
                    ratingmessage += 'data-id="' + rating.RatingID + '"'
                    ratingmessage += '> '
                    ratingmessage += '<div class="icon-div">'
                    ratingmessage += '<img class="userIcon" src="' + rating.NameAndImage[1] + '" />'
                    ratingmessage += '</div>'
                    ratingmessage += '<h5 class="d-inline">' + rating.NameAndImage[0] + '</h5>'
                    ratingmessage += '<h5>' + ratingstars + '</h5>'
                    ratingmessage += '<h5>' + rating.Comment + '</h5>'
                    ratingmessage += '</div>'

                    $("#RatingMessages").append(ratingmessage);
                });

                var image = new Image();
                $(".userIcon").each(function () {
                    image.src = $(this).attr("src");
                    $(this).removeAttr("style");
                    $(this).css(image.width > image.height ? "height" : "width", "100px");
                })
            },
            failure: function (response) {
                alert(response);
            }
        });

    }

    function getScrollBarWidth() {
        var $outer = $('<div>').css({ visibility: 'hidden', width: 100, overflow: 'scroll' }).appendTo('body'),
            widthWithScroll = $('<div>').css({ width: '100%' }).appendTo($outer).outerWidth();
        $outer.remove();
        return 100 - widthWithScroll;
    };

    $.fn.isInViewport = function () {
        var elementTop = $(this).offset().top;
        var elementBottom = elementTop + $(this).outerHeight();
        var viewportTop = $(window).scrollTop();
        var viewportBottom = viewportTop + $(window).height();
        return elementBottom > viewportTop && elementTop < viewportBottom;
    };

</script>

@await Html.PartialAsync("_Authentication")
