@page
@model JaminBooks.Pages.BookModel
@{
    ViewData["Title"] = "Book";
    ViewData["IsLoggedIn"] = Model.CurrentUser != null;
    ViewData["Name"] = Model.CurrentUser == null ? "" : Model.CurrentUser.FirstName + " " + Model.CurrentUser.LastName;
    ViewData["CartCount"] = Model.CurrentUser == null ? 0 : Model.CurrentUser.GetCart().Count;

    if (Model.CurrentUser != null && Model.CurrentUser.IsAdmin)
    {
        Layout = "~/Pages/Admin/_AdminLayout.cshtml";
    }
    else
    {
        Layout = "~/Pages/_Layout.cshtml";
    }
}

<style>
    #BookViewBody {
        width: 75%;
        margin: auto;
        background-color: white;
        margin-top: 100px;
        margin-bottom: 50px;
        position: relative;
    }

    #BookImage {
        height: 350px;
        position: absolute;
        top: -50px;
        left: -50px;
    }
    #AdminOptions {
        position: absolute;
        top: 20px;
        right: 30px;
        width: 500px;
    }
</style>

<span class="d-none" id="UserID">@(Model.CurrentUser == null ? -1 : Model.CurrentUser.UserID)</span>
<span class="d-none" id="UserIsAdmin">@(Model.CurrentUser == null ? false : Model.CurrentUser.IsAdmin)</span>

@if (Model.CurrentUser.IsAdmin)
{
    <div id="AdminOptions" class="float-right">
        <div class="row">
            <div class="col-6">
                <a href="\Admin\BookCreate?id=@Model.Book.BookID" class="btn btn-success btn-block">Edit <i class="fas fa-edit ml-2"></i></a>
            </div>
            <div class="col-6">
                @if (Model.Book.IsDeleted)
                {
                    <button class="btn btn-warning btn-block" onclick="undeleteBook(event, this)">Undelete <i class="fas fa-sign-in-alt ml-2"></i></button>
                }
                else
                {
                    <button class="btn btn-danger btn-block" onclick="deleteBook(event, this)">Delete <i class="fas fa-trash ml-2"></i></button>
                }
            </div>
        </div>
    </div>

    <script>
            function undeleteBook(event, button) {
                $.confirm({
                    title: 'Undelete Book',
                    content: 'Are you sure you want to undelete this book?',
                    type: 'orange',
                    buttons: {
                        delete: {
                            text: 'Undelete',
                            btnClass: 'btn-orange',
                            action: function () {
                                $.ajax({
                                    type: "POST",
                                    url: "/Model/UndeleteBook",
                                    beforeSend: function (xhr) {
                                        xhr.setRequestHeader("XSRF-TOKEN",
                                            $('input:hidden[name="__RequestVerificationToken"]').val());
                                    },
                                    data: JSON.stringify({
                                        ID: @Model.Book.BookID
                                    }),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function (logout) {
                                        location.reload();
                                    },
                                    failure: function (response) {
                                        alert(response);
                                    }
                                });
                            }
                        },
                        Cancel: function () { }
                    }
                });
                event.stopPropagation();
                return false;
            }

            function deleteBook(event, button) {
                $.confirm({
                    title: 'Delete Book',
                    icon: 'fas fa-exclamation',
                    content: 'Are you sure you want to delete this book? This will set the quantity in stock equal to zero.',
                    type: 'red',
                    buttons: {
                        delete: {
                            text: 'Delete',
                            btnClass: 'btn-red',
                            action: function () {
                                $.ajax({
                                    type: "POST",
                                    url: "/Model/DeleteBook",
                                    beforeSend: function (xhr) {
                                        xhr.setRequestHeader("XSRF-TOKEN",
                                            $('input:hidden[name="__RequestVerificationToken"]').val());
                                    },
                                    data: JSON.stringify({
                                        ID: @Model.Book.BookID
                                    }),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function (logout) {
                                        location.reload();
                                    },
                                    failure: function (response) {
                                        alert(response);
                                    }
                                });
                            }
                        },
                        Cancel: function () { }
                    }
                });
                event.stopPropagation();
                return false;
            }
    </script>
}

<div class="container">
    <div id="BookView">
        <div id="BookViewBody" class="pb-5">
            <img id="BookImage" src="@Model.Book.LoadImage" />
            <div class="container" style="overflow:auto;">
                <div class="row mt-3">
                    <div class="col-3">
                        <div style="margin-top: 320px">
                            @{ var count = Model.Book.Quantity; }
                            <h5 class="w-75 ml-4 text-center"><span id="BookQuantity" class="@(count <= 5 ? "text-danger" : "")">@(@Model.Book.IsDeleted ? "Removed From Stock" : count == 0 ? "Out Of Stock" : (count <= 5 ? "Only " : "") + count + " In Stock")</span></h5>
                            <button id="AddToCart" class="btn btn-dark-red text-white btn-lg ml-4 mt-2 w-75" @(count == 0 ? "disabled" : "")>Add to Cart</button>
                        </div>
                    </div>
                    <div class="col-8">
                        <span id="BookID" class="d-none">@Model.Book.BookID</span>
                        <h2 id="BookTitle">@Model.Book.Title</h2>
                        <h4 id="BookAuthor">@(string.Join(",", Model.Book.Authors.Select(a => string.Format("{0} {1}", a.FirstName, a.LastName))))</h4>
                        <h3>$<span id="BookPrice">@Model.Book.Price.ToString("0.00")</span></h3>
                        <div id="Rating">
                            <span>
                                @{
                                    var rating = Model.Book.Rating;
                                }
                                @for (int i = 0; i < Model.Book.Rating; i++)
                                {
                                    <i class="fas fa-star"></i>
                                }
                                @for (int i = 0; i < 5 - Model.Book.Rating; i++)
                                {
                                    <i class="far fa-star"></i>
                                }
                            </span>
                        </div>
                        <div id="Categories" class="mt-2">
                            @foreach (Model.Category cat in Model.Book.Categories)
                            {
                                <span class="badge badge-primary m-1">@cat.CategoryName</span>
                            }
                        </div>
                        <div id="Description" class="mt-3">@Model.Book.Description</div>
                        <hr />
                        <div id="Details" class="mt-3">
                            <div class="row">
                                <div class="col-lg-6 col-md-12">
                                    <div class="form-group row">
                                        <label class="col-4 col-form-label font-weight-bold">ISBN 10:</label>
                                        <div class="col-8">
                                            <input id="ISBN10" type="text" readonly class="form-control-plaintext" value="@Model.Book.ISBN10">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-4 col-form-label font-weight-bold">ISBN 13:</label>
                                        <div class="col-8">
                                            <input id="ISBN13" type="text" readonly class="form-control-plaintext" value="@Model.Book.ISBN13">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-4 col-form-label font-weight-bold">Copyright:</label>
                                        <div class="col-8">
                                            <input id="CopyrightDate" type="text" readonly class="form-control-plaintext" value="@Model.Book.CopyrightDate.ToString("M/d/yyyy")">
                                        </div>
                                    </div>
                                    @if (Model.CurrentUser.IsAdmin)
                                    {
                                        <div class="form-group row">
                                            <label class="col-4 col-form-label font-weight-bold">Cost:</label>
                                            <div class="col-8">
                                                <input id="Cost" type="text" readonly class="form-control-plaintext" value="$@Model.Book.Cost.ToString("0.00")">
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-12 col-form-label font-weight-bold">Publisher Address:</label>
                                        </div>
                                        <div class="form-group row ml-3">
                                            <h6>@Model.Book.Publisher.Address.Line1</h6>

                                            @if (Model.Book.Publisher.Address.Line2 != null)
    {
                                        <h6>@Model.Book.Publisher.Address.Line2</h6>
}

                                            @if (Model.Book.Publisher.Address.State != null)
    {
                                        <h6>@Model.Book.Publisher.Address.City, @Model.Book.Publisher.Address.State @Model.Book.Publisher.Address.ZIP</h6>
}
else
{
                                        <h6>@Model.Book.Publisher.Address.City, @Model.Book.Publisher.Address.Country @Model.Book.Publisher.Address.ZIP</h6>
}
                                        </div>
                                    }
                                </div>
                                <div class="col-lg-6 col-md-12">
                                    <div class="form-group row">
                                        <label class="col-4 col-form-label font-weight-bold">Publication Date:</label>
                                        <div class="col-8">
                                            <input id="PublicationDate" type="text" readonly class="form-control-plaintext" value="@Model.Book.PublicationDate.ToString("M/d/yyyy")">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-4 col-form-label font-weight-bold">Publisher:</label>
                                        <div class="col-8">
                                            <input id="Publisher" type="text" readonly class="form-control-plaintext" value="@Model.Book.Publisher.PublisherName">
                                        </div>
                                    </div>
                                    @if (Model.CurrentUser.IsAdmin)
    {
                                <div class="form-group row">
                                    <label class="col-4 col-form-label font-weight-bold">Publisher Contact:</label>
                                    <div class="col-8">
                                        <input id="PublisherContact" type="text" readonly class="form-control-plaintext" value="@Model.Book.Publisher.FullName">
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-4 col-form-label font-weight-bold">Publisher Number:</label>
                                    <div class="col-8">
                                        <input id="PublisherNumber" type="text" readonly class="form-control-plaintext" value="@Model.Book.Publisher.Phone.Number">
                                    </div>
                                </div>
}
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div id="Ratings" class="mt-3">
                            <h3>Leave a review</h3>
                            <div class="col-12">
                                <span id="RatingStars">
                                    <span class="star-overlay"></span>
                                    <i class="fas fa-star"></i>
                                    <span class="star-overlay"></span>
                                    <i class="far fa-star"></i>
                                    <span class="star-overlay"></span>
                                    <i class="far fa-star"></i>
                                    <span class="star-overlay"></span>
                                    <i class="far fa-star"></i>
                                    <span class="star-overlay"></span>
                                    <i class="far fa-star"></i>
                                </span>
                                <textarea id="Comment" class="w-100 mt-2 mb-2 form-control" placeholder="What did you think?..."></textarea>
                                <button id="SubmitRating" class="btn btn-dark-red text-white">Submit Review</button>
                            </div>
                            <div id="RatingMessages" class="mt-3"></div>
                            <div id="RatingLoadIcon" class="row text-center mt-1 mb-1">
                                <div class="col-12">
                                    <i class="fas fa-circle-notch fa-spin fa-4x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="RatingModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <span id="EditRatingStars">
                                    <span class="star-overlay"></span>
                                    <i class="fas fa-star"></i>
                                    <span class="star-overlay"></span>
                                    <i class="far fa-star"></i>
                                    <span class="star-overlay"></span>
                                    <i class="far fa-star"></i>
                                    <span class="star-overlay"></span>
                                    <i class="far fa-star"></i>
                                    <span class="star-overlay"></span>
                                    <i class="far fa-star"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <textarea id="EditComment" class="w-100 mt-2 mb-2 form-control" placeholder="What did you think?..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 offset-3 text-center">
                            <input id="SaveRating" type="submit" value="Save" class="btn btn-success btn-block">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_Ratings")
<script>
    $(document).ready(function () {
        loadRatings();

        $("#AddToCart").click(function () {
            $.ajax({
                type: "POST",
                url: "Model/AddToCart",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                },
                data: JSON.stringify({ BookID: $("#BookID").text() }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    var code = JSON.parse(response);
                    if (code == 1) {
                        $.confirm({
                            title: $("#BookTitle").text() + ' added to cart.',
                            content: 'Would you like to view your cart?',
                            type: 'green',
                            buttons: {
                                yes: {
                                    text: 'View Cart',
                                    btnClass: 'btn-green',
                                    action: function () {
                                        location.href = "/Cart";
                                    }
                                },
                                no: {
                                    text: 'No Thanks'
                                }
                            }
                        });
                    } else if (code == 2) {
                        $.confirm({
                            title: $("#BookTitle").text() + ' In Cart.',
                            content: $("#BookTitle").text() + ' is already in your cart. Would you like to view your cart?',
                            type: 'blue',
                            buttons: {
                                yes: {
                                    text: 'View Cart',
                                    btnClass: 'btn-blue',
                                    action: function () {
                                        location.href = "/Cart";
                                    }
                                },
                                no: {
                                    text: 'No Thanks'
                                }
                            }
                        });
                    } else {
                        $("body").append("<span id='LoginRedirectLocation'>\Books?title=" + $("#BookTitle").text() + "</span>")
                        $("#ShowLogin").click();
                    }
                },
                failure: function (response) {
                    alert(response);
                }
            });
        });
    });
</script>
@await Html.PartialAsync("_Authentication")



