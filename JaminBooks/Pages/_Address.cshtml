<!--ADDRESS-->
<!--This is a partial page appended to other pages to allow for the creation, editing, and deletion of addresses.-->
<div class="modal fade" id="AddressModal" data-id="-1" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <div class="row mb-2">
                            <div class="col-12">
                                <input type="text" id="ShipLine1" class="form-control" maxlength="100" placeholder="Line 1">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-12">
                                <input type="text" id="ShipLine2" class="form-control" maxlength="100" placeholder="Line 2 (optional)">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-12">
                                <input type="text" id="ShipCity" class="form-control" maxlength="100" placeholder="City">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-12">
                                <select id="ShipState" class="form-control">
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="DC">District Of Columbia</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-12">
                                <select id="ShipCountry" class="form-control">
                                    <option value="Canada">Canada</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Mexico">Mexico</option>
                                    <option value="UK">United Kingdom</option>
                                    <option selected value="US">United States</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-12">
                                <input type="text" id="ShipZIP" class="form-control" maxlength="5" placeholder="ZIP">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 offset-3 text-center">
                        <input id="SaveAddress" type="submit" value="Save" class="btn btn-success btn-block">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    //The EditAddress and Deleted Address methods are added to the onlcick
    //attribute when the address is added wither by the javascript or razor

    //Fires when the edit button on an adress is clicked
    function EditAddress(button) {
        var card = $(button).parents(".address");
        $("#AddressModal").data("id", card.data("id"));
        $("#ShipLine1").val(card.data("line1"));
        $("#ShipLine2").val(card.data("line2"));
        $("#ShipCity").val(card.data("city"));
        $("#ShipState").val(card.data("state"));
        $("#ShipCountry").val(card.data("country"));
        $("#ShipZIP").val(card.data("zip"));
        $("#AddressModal").modal("show");
    }

    //Fires when the delete button on an address is clicked
    function DeleteAddress(button) {
        var add = $(button).parents(".address");
        $.confirm({
            title: 'Delete Address',
            content: 'Are you sure you want to delete this shipping address?',
            type: 'red',
            buttons: {
                yes: function () {
                    //Send an AJAX call to the Model Controller to Delete the address
                    $.ajax({
                        type: "POST",
                        url: "Model/DeleteAddress",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader("XSRF-TOKEN",
                                $('input:hidden[name="__RequestVerificationToken"]').val());
                        },
                        data: JSON.stringify({
                            ID: add.data("id")
                        }),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function () {
                            add.fadeOut(function () {
                                add.remove();
                            });
                        },
                        failure: function (response) {
                            location.href = "\Error"
                        }
                    });
                },
                no: function () { }
            }
        });
    }

    $(document).ready(function () {
        //Show the modal when the button is clicked.
        $("#AddressCreate").click(function () {
            $("#AddressModal").modal("show");
        });

        //Hide the state section if a non-US country is selected
        $("#ShipCountry").change(function () {
            if ($("#ShipCountry").val() != "US")
                $("#ShipState").parent().hide();
            else $("#ShipState").parent().show();
        });

        //Fires when the save address button is clicked
        $("#SaveAddress").click(function () {

            var data = {
                ID: $("#AddressModal").data("id"),
                Line1: $("#ShipLine1").val(),
                Line2: $("#ShipLine2").val(),
                City: $("#ShipCity").val(),
                State: $("#ShipState").val(),
                Country: $("#ShipCountry").val(),
                ZIP: $("#ShipZIP").val(),
                UserID: $("#UserID").text()
            };

            //Verify that all of the required fields are filled
            if (validateShipAddress()) {
                $.ajax({
                    type: "POST",
                    url: "Model/SaveAddress",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN",
                            $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        var address = $(".address[data-id='" + response[0] + "']");
                        address.fadeOut(function () {
                            address.remove();
                        });

                        var card = "";

                        card += '<div class="card address d-inline-block" data-id="' + response[1] + '" style="width:300px" '
                        card += 'data-line1="' + data.Line1 + '" ';
                        card += 'data-line2="' + data.Line2 + '" ';
                        card += 'data-state="' + data.State + '" ';
                        card += 'data-city="' + data.City + '" ';
                        card += 'data-country="' + data.Country + '" ';
                        card += 'data-zip="' + data.ZIP + '" ';
                        card += '>'
                        card += '<div class="card-header">'
                        card += '<button type="button" onclick="EditAddress(this)" class="btn btn-sm btn-success mr-1"><i class="fas fa-edit"></i></button>'
                        card += '<button type="button" onclick="DeleteAddress(this)" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>'
                        card += '</div>'
                        card += '<div class="card-body">'
                        card += '<h6 class="card-title">' + data.Line1 + '</h6>'
                        if (data.Line2 != "")
                            card += '<h6 class="card-title text-muted">' + data.Line2 + '</h6>'
                        //If the country is US, show the states, else show the country name.
                        card += '<h6 class="card-title text-muted">' + data.City + ', ' + (data.Country != "US" ? data.Country : data.State) + ' ' + data.ZIP + '</h6>'
                        card += '</div>'
                        card += '</div>'

                        $("#Addresses .card:last").before(card);

                        $("#AddressModal").modal("hide");
                    },
                    failure: function (response) {
                        location.href = "\Error"
                    }
                });
            }
        });

        //Clear the modal fields when it closes.
        $('#AddressModal').on('hidden.bs.modal', function () {
            $("#ShipLine1").val("");
            $("#ShipLine2").val("");
            $("#ShipCity").val("");
            $("#ShipZIP").val("");
        })

        //Ensure all required fields have valid values.
        function validateShipAddress() {
            var valid = true;

            $("#ShipLine1").removeAttr("style");
            $("#ShipCity").removeAttr("style");
            $("#ShipZIP").removeAttr("style");

            if ($("#ShipLine1").val() == "") {
                $("#ShipLine1").css("border-color", "red");
                valid = false;
            }

            if ($("#ShipCity").val() == "") {
                $("#ShipCity").css("border-color", "red");
                valid = false;
            }

            if ($("#ShipZIP").val() == "") {
                $("#ShipZIP").css("border-color", "red");
                valid = false;
            }

            return valid;
        }
    });
</script>